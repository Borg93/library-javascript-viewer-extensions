(window.webpackJsonp=window.webpackJsonp||[]).push([[93],{526:function(e,i,t){var n=t(44),r=t(536),a=t(551),o="Expected a function",s=Math.max,u=Math.min;e.exports=function(e,i,t){var l,d,c,p,v,h,f=0,m=!1,y=!1,k=!0;if("function"!=typeof e)throw new TypeError(o);function g(i){var t=l,n=d;return l=d=void 0,f=i,p=e.apply(n,t)}function x(e){var t=e-h;return void 0===h||t>=i||t<0||y&&e-f>=c}function E(){var e=r();if(x(e))return w(e);v=setTimeout(E,function(e){var t=i-(e-h);return y?u(t,c-(e-f)):t}(e))}function w(e){return v=void 0,k&&l?g(e):(l=d=void 0,p)}function M(){var e=r(),t=x(e);if(l=arguments,d=this,h=e,t){if(void 0===v)return function(e){return f=e,v=setTimeout(E,i),m?g(e):p}(h);if(y)return v=setTimeout(E,i),g(h)}return void 0===v&&(v=setTimeout(E,i)),p}return i=a(i)||0,n(t)&&(m=!!t.leading,c=(y="maxWait"in t)?s(a(t.maxWait)||0,i):c,k="trailing"in t?!!t.trailing:k),M.cancel=function(){void 0!==v&&clearTimeout(v),f=0,l=h=d=v=void 0},M.flush=function(){return void 0===v?p:w(r())},M}},531:function(e,i,t){var n=t(526),r=t(44),a="Expected a function";e.exports=function(e,i,t){var o=!0,s=!0;if("function"!=typeof e)throw new TypeError(a);return r(t)&&(o="leading"in t?!!t.leading:o,s="trailing"in t?!!t.trailing:s),n(e,i,{leading:o,maxWait:i,trailing:s})}},536:function(e,i,t){var n=t(51);e.exports=function(){return n.Date.now()}},641:function(e,i,t){e.exports=t.p+"a91f7a1f684a8cae1c93a3e15fda6826.png"},887:function(e,i,t){"use strict";t.r(i);var n=t(888);i.default=n.a},888:function(e,i,t){"use strict";(function(e){t.d(i,"a",function(){return g});var n=t(2),r=t.n(n),a=t(3),o=t.n(a),s=t(5),u=t.n(s),l=t(4),d=t.n(l),c=t(50),p=t.n(c),v=t(6),h=t.n(v),f=t(121),m=(t(531),t(641)),y=t.n(m),k=t(528),g=function(i){function t(e){var i,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r()(this,t),(i=u()(this,d()(t).call(this))).onCameraChanged=i.onCameraChanged.bind(p()(i)),i.onVisibility=i.onVisibility.bind(p()(i)),i.onExplode=i.onExplode.bind(p()(i)),i.viewer=e,i.dbIds=i.getAllDbIds(),i.eventHandlers=[{event:Autodesk.Viewing.EXPLODE_CHANGE_EVENT,handler:i.onExplode},{event:Autodesk.Viewing.CAMERA_CHANGE_EVENT,handler:i.onCameraChanged},{event:Autodesk.Viewing.ISOLATE_EVENT,handler:i.onVisibility},{event:Autodesk.Viewing.HIDE_EVENT,handler:i.onVisibility},{event:Autodesk.Viewing.SHOW_EVENT,handler:i.onVisibility}],i.eventHandlers.forEach(function(e){i.viewer.addEventListener(e.event,e.handler)}),i.geometry=new THREE.Geometry;for(var a=n.maxPoints||1e4,o=0;o<a;++o)i.geometry.vertices.push(new THREE.Vector3);return i.shader=i.createShader(n),i.pointCloud=new THREE.PointCloud(i.geometry,i.shader.material),i.pointCloud.frustumCulled=!1,i.viewer.impl.sceneAfter.add(i.pointCloud),i.options=n,i.markups=[],i}return h()(t,i),o()(t,[{key:"createShader",value:function(e){var i=e.vertexShader||"\n      attribute float pointSize;\n      attribute vec4 color;\n      varying vec4 vColor;\n      void main() {\n        vec4 vPosition = modelViewMatrix * vec4(position, 1.0);\n        gl_Position = projectionMatrix * vPosition;\n        gl_PointSize = pointSize;\n        vColor = color;\n      }\n    ",t=e.fragmentShader||"\n      uniform sampler2D texture;\n      varying vec4 vColor;\n      void main() {\n        vec4 tex = texture2D(texture, gl_PointCoord);\n        if (tex.a < 0.2) discard;\n        if (vColor.a == 0.0) {\n          gl_FragColor = vec4(tex.r, tex.g, tex.b, tex.a);\n        } else {\n          gl_FragColor = vColor;\n        }\n      }\n    ",n=e.texture||y.a,r=e.shaderParams||{side:THREE.DoubleSide,depthWrite:!1,depthTest:!1,fragmentShader:t,vertexShader:i,opacity:.5,attributes:{pointSize:{type:"f",value:[]},color:{type:"v4",value:[]}},uniforms:{texture:{value:THREE.ImageUtils.loadTexture(n),type:"t"}}},a=new THREE.ShaderMaterial(r),o=new k.a,s=0;return{setTexture:function(e){var i=r.uniforms.texture;i.value=THREE.ImageUtils.loadTexture(e),i.needsUpdate=!0},update:function(){var e=.001*o.getElapsedMs();s=(s+=.25*e)>.5?0:s;var i=r.uniforms.texture;i.value=function(e,i){for(var t=[],n=0;n<e;++n)for(var r=0;r<e;++r){var a=Math.sqrt((n/e-.5)*(n/e-.5)+(r/e-.5)*(r/e-.5));a<.1?t.push(255,0,0,255):a<i-.05?t.push(255,0,0,0):a<i?t.push(255,0,0,255):t.push(0,0,0,0)}var o=new THREE.DataTexture(Uint8Array.from(t),e,e,THREE.RGBAFormat,THREE.UnsignedByteType,THREE.UVMapping);return o.minFilter=THREE.LinearMipMapLinearFilter,o.magFilter=THREE.LinearFilter,o.needsUpdate=!0,o}(96,s),i.needsUpdate=!0},material:a}}},{key:"startAnimation",value:function(){var e=this;this.markups.forEach(function(i){e.setMarkupColor(i.id,i.color)}),this.viewer.impl.invalidate(!0),this.runAnimation=!0}},{key:"stopAnimation",value:function(){var e=this,i=this.options.texture||y.a;this.shader.setTexture(i),this.markups.forEach(function(i){e.setMarkupColor(i.id,new THREE.Vector4(0,0,0,0),!0)}),this.viewer.impl.invalidate(!0),this.runAnimation=!1}},{key:"update",value:function(e){this.shader.update(e),this.viewer.impl.invalidate(!1,!0,!1)}},{key:"getMarkupById",value:function(e){var i=this.markups.filter(function(i){return i.id===e});return i.length?i[0]:null}},{key:"setMarkupSize",value:function(e,i,t){var n=this.pointCloud.material.attributes.pointSize,r=this.getMarkupById(e),a=r.visible&&r.__visible;t?n.value[r.index]=i:a&&(r.occlusion&&this.checkOcclusion(r)||(n.value[r.index]=i)),r.size=t?r.size:i,n.needsUpdate=!0,this.viewer.impl.invalidate(!0)}},{key:"setMarkupColor",value:function(e,i,t){var n=this.pointCloud.material.attributes.color,r=this.getMarkupById(e);n.value[r.index]=i,r.color=t?r.color:i,n.needsUpdate=!0,this.viewer.impl.invalidate(!0)}},{key:"getFragmentPos",value:function(e){var i=this.viewer.impl.getRenderProxy(this.viewer.model,e),t=new THREE.Vector3;return t.setFromMatrixPosition(i.matrixWorld),t}},{key:"addMarkup",value:function(e){var i=e.size||this.options.markupSize||40,t=this.markups.length,n=Object.assign({},{initialFragPos:this.getFragmentPos(e.fragId),color:new THREE.Vector4(1,0,0,1),name:"Markup "+(t+1),id:this.guid("xxx-xxx-xxx"),__visible:!0,occlusion:!0,visible:!0,size:i},e,{index:t}),r=this.geometry.vertices[n.index];return r.x=n.point.x,r.y=n.point.y,r.z=n.point.z,this.geometry.verticesNeedUpdate=!0,this.markups.push(n),this.setMarkupSize(n.id,n.size),this.updateMarkup(n),this.setMarkupColor(n.id,this.runAnimation?n.color:new THREE.Vector4(0,0,0,0),!this.runAnimation),this.emit("markup.created",n),n}},{key:"removeMarkup",value:function(e){var i=this,t=this.pointCloud.material.attributes.pointSize;this.markups=this.markups.filter(function(i){return i.id!==e}),this.markups.forEach(function(e,n){var r=i.geometry.vertices[n];t.value[n]=e.size,r.x=e.point.x,r.y=e.point.y,r.z=e.point.z,e.index=n,i.updateMarkup(e)});for(var n=this.markups.length;n<this.geometry.vertices.length;++n)t.value[n]=0;this.geometry.verticesNeedUpdate=!0,t.needsUpdate=!0,this.viewer.impl.invalidate(!0),this.emit("markup.deleted",e)}},{key:"clearMarkups",value:function(){for(var e=this.pointCloud.material.attributes.pointSize,i=this.geometry.vertices.length,t=0;t<i;++t)e.value[t]=0;e.needsUpdate=!0,this.viewer.impl.invalidate(!0),this.markups=[]}},{key:"setMarkupPosition",value:function(e,i){var t=this.getMarkupById(e),n=this.geometry.vertices[t.index];n.x=i.x,n.y=i.y,n.z=i.z,this.geometry.verticesNeedUpdate=!0}},{key:"setMarkupData",value:function(e,i){var t=this.getMarkupById(e);Object.assign(t,i)}},{key:"setMarkupVisibility",value:function(e,i){var t=this.getMarkupById(e);t.visible=i,this.updateMarkup(t)}},{key:"__setMarkupVisibility",value:function(e,i){var t=this.getMarkupById(e);t.__visible=i,this.updateMarkup(t)}},{key:"setMarkupOcclusion",value:function(e,i){var t=this.getMarkupById(e);t.occlusion=i,this.updateMarkup(t)}},{key:"updateMarkup",value:function(e){if(e.visible&&e.__visible)if(e.occlusion){var i=this.checkOcclusion(e);this.setMarkupSize(e.id,i?0:e.size,!0)}else this.setMarkupSize(e.id,e.size,!0);else this.setMarkupSize(e.id,0,!0)}},{key:"getState",value:function(){return{markups:this.markups}}},{key:"restoreState",value:function(){var e=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.clearMarkups(),i.markups&&i.markups.forEach(function(i){e.addMarkup(i)})}},{key:"onCameraChanged",value:function(e){var i=this;this.markups.forEach(function(e){if(e.visible&&e.__visible&&e.occlusion){var t=i.checkOcclusion(e);i.setMarkupSize(e.id,t?0:e.size,!0)}})}},{key:"onExplode",value:function(e){var i=this;this.markups.forEach(function(e){if(e.visible&&e.__visible){var t=i.getFragmentPos(e.fragId),n=e.point,r=e.initialFragPos,a={x:n.x+t.x-r.x,y:n.y+t.y-r.y,z:n.z+t.z-r.z};i.setMarkupPosition(e.id,a)}})}},{key:"onVisibility",value:function(e){var i=this;this.markups.forEach(function(t){var n=e.nodeIdArray;switch(e.type){case"isolate":n.indexOf(t.dbId)>-1||!n.length?i.__setMarkupVisibility(t.id,!0):n.length&&i.__setMarkupVisibility(t.id,!1);break;case"hide":n.indexOf(t.dbId)>-1&&i.__setMarkupVisibility(t.id,!1);break;case"show":n.indexOf(t.dbId)>-1&&i.__setMarkupVisibility(t.id,!0)}})}},{key:"pointToRaycaster",value:function(e,i,t){var n=new THREE.Vector3,r=new THREE.Vector3,a=new THREE.Raycaster,o=e.getBoundingClientRect(),s=(t.x-o.left)/o.width*2-1,u=-(t.y-o.top)/o.height*2+1;return i.isPerspective?(n.set(s,u,.5),n.unproject(i),a.set(i.position,n.sub(i.position).normalize())):(n.set(s,u,-1),n.unproject(i),r.set(0,0,-1),a.set(n,r.transformDirection(i.matrixWorld))),a}},{key:"getSelection",value:function(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.9,t=this.pointToRaycaster(this.viewer.impl.canvas,this.viewer.impl.camera,{x:e.x,y:e.y}),n=t.intersectObjects([this.pointCloud],!0);return n.length?this.markups.filter(function(e){var t=n[0].point.x-e.point.x,r=n[0].point.y-e.point.y,a=n[0].point.z-e.point.z;return Math.sqrt(t*t+r*r+a*a)<i}):[]}},{key:"checkOcclusion",value:function(i){var t=this.viewer.worldToClient(i.point),n=e(this.viewer.container).offset(),r=this.pointToRaycaster(this.viewer.impl.canvas,this.viewer.impl.camera,{x:t.x+n.left,y:t.y+n.top}),a=this.viewer.model.rayIntersect(r,!0,this.dbIds);if(a){if(a.fragId===i.fragId){var o={x:a.point.x-i.point.x,y:a.point.y-i.point.y,z:a.point.z-i.point.z},s=Math.sqrt(o.x*o.x+o.y*o.y+o.z*o.z);if(this.options.logOcclusionDist&&console.log(s),s<this.options.occlusionDist)return!1}return!0}}},{key:"getAllDbIds",value:function(){var e=this.viewer.model.getData().instanceTree.nodeAccess.dbIdToIndex;return Object.keys(e).map(function(e){return parseInt(e)})}},{key:"destroy",value:function(){var e=this;this.viewer.impl.sceneAfter.remove(this.pointCloud),this.eventHandlers.forEach(function(i){e.viewer.removeEventListener(i.event,i.handler)}),this.runAnimation=!1,this.markups=[],this.off()}}]),t}(f.a)}).call(this,t(21))}}]);
//# sourceMappingURL=93.js.map